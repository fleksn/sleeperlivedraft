<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sleeper Draft ‚Äì Best Available (Live)</title>
  <style>
    :root {
      --bg:#0b1020; --card:#0f1530; --ink:#e7ecff; --muted:#aab3d6;
      --accent:#6ea8fe; --good:#2ecc71; --bad:#ff6b6b;
      --tier1:#6ea8fe; --tier2:#2ecc71; --tier3:#f1c40f;
      --tier4:#e67e22; --tier5:#e74c3c; --tierOther:#95a5a6;
      --glass: rgba(255,255,255,0.03);
      --card-border: rgba(255,255,255,0.06);
      --muted-2: rgba(255,255,255,0.12);
    }
    /* Light theme overrides */
    body.light {
      --bg: #f6f7fb; --card: #ffffff; --ink: #0b1220; --muted: #6b7280;
      --accent: #2563eb; --good:#16a34a; --bad:#ef4444; --glass: rgba(2,6,23,0.03);
      --card-border: rgba(2,6,23,0.06); --muted-2: rgba(2,6,23,0.06);
    }

    html,body{height:100%}
    body{margin:0;font:15px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,var(--bg),#070a16);color:var(--ink);-webkit-font-smoothing:antialiased}
    .wrap{max-width:1180px;margin:24px auto;padding:16px}

    /* layout */
    .grid{display:grid;gap:12px}
    .grid.cols{grid-template-columns: 1.25fr .75fr}
    @media (max-width:1100px){.grid.cols{grid-template-columns: 1fr}}

    /* cards */
    .card{background:var(--card);border:1px solid var(--card-border);border-radius:14px;box-shadow:0 8px 24px rgba(2,6,23,0.45)}
    .card h2{margin:0 0 8px 0;font-size:18px}
    .pad{padding:16px}

    /* rows & input */
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1 1 180px}
    input,select,button,textarea{background:transparent;color:var(--ink);border:1px solid var(--card-border);border-radius:10px;padding:10px 12px}
    input:focus,select:focus,textarea:focus{outline:2px solid rgba(110,168,254,0.18);box-shadow:0 6px 18px rgba(110,168,254,0.06)}

    /* buttons */
    .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:1px solid transparent;cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(180deg,var(--accent),#3f8efc);color:white}
    .btn.ghost{background:transparent;border:1px solid var(--card-border);color:var(--ink)}
    .btn.warn{background:linear-gradient(180deg,var(--bad),#ff4b4b);color:white}
    .btn.flat{background:transparent;color:var(--muted)}
    .btn:active{transform:translateY(1px)}

    .muted{color:var(--muted)}
    .stat{font-weight:700}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--glass);border:1px solid var(--card-border);font-size:12px}

    /* table */
    .scroll{max-height:64vh;overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;background:transparent}
    thead th{position:sticky;top:0;background:linear-gradient(180deg,transparent,var(--card));text-align:left;padding:12px;border-bottom:1px solid var(--card-border);backdrop-filter: blur(4px)}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.03)}
    tbody tr{transition:background .15s,transform .05s}
    tbody tr:hover{background:rgba(255,255,255,0.03);transform:translateY(-1px)}
    tbody tr:nth-child(even):not(.tierRow){background: rgba(255,255,255,0.012)}
    .right{text-align:right}

    /* tier break */
    .tierRow td{background:transparent;border-top:2px solid rgba(255,255,255,0.06);padding:8px 12px;font-weight:700}

    /* avatar + name */
    .playerCell{display:flex;align-items:center;gap:10px}
    .avatar{width:36px;height:36px;border-radius:999px;background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));display:inline-grid;place-items:center;font-weight:700;color:var(--ink);border:1px solid var(--card-border)}
    .playerName{font-weight:700}
    .playerMeta{font-size:12px;color:var(--muted)}

    /* toggle (styled checkbox) */
    .toggle{display:inline-block;width:48px;height:26px;position:relative}
    .toggle input{position:absolute;opacity:0;width:0;height:0}
    .slider{position:absolute;inset:0;border-radius:999px;background:rgba(255,255,255,0.06);transition:all .18s;box-shadow:inset 0 -2px 6px rgba(0,0,0,0.2)}
    .slider::after{content:'';position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:var(--card);box-shadow:0 6px 16px rgba(2,6,23,0.5);transition:all .18s}
    .toggle input:checked + .slider{background:linear-gradient(90deg,var(--good),#27ae60)}
    .toggle input:checked + .slider::after{transform:translateX(22px);background:white}

    /* star button */    
    .starBtn{background:transparent;border:0;cursor:pointer;padding:6px;border-radius:8px}
    .starBtn.active{color:var(--tier1);filter:drop-shadow(0 6px 18px rgba(110,168,254,0.06))}

    /* misc */
    .code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;background:var(--glass);border:1px solid var(--card-border);padding:8px 10px;border-radius:8px}
    .recent{list-style:none;margin:8px 0 0 0;padding:0;max-height:240px;overflow:auto}
    .recent li{display:flex;justify-content:space-between;gap:8px;padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.03)}

    @media (max-width:700px){
      .btn .icon{display:none}
      .avatar{width:30px;height:30px}
    }
  .recent li .undoBtn{background:transparent;border:1px solid var(--card-border);padding:2px 6px;border-radius:6px;font-size:12px;color:var(--muted);cursor:pointer;margin-left:6px}
    .recent li .undoBtn:hover{background:var(--glass)}
  </style>
</head>
<body>
  <div class="wrap grid cols">
    <section class="card pad">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px">
        <div>
          <h2>Live Best Available</h2>
          <div class="muted tiny">Real-time board ‚Äî drop in your Sleeper Draft ID & rankings</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <label class="toggle" title="Dark / Light mode">
            <input type="checkbox" id="themeToggle" />
            <span class="slider"></span>
          </label>
          <div class="muted tiny">Light</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label class="tiny">Sleeper Draft ID</label>
          <input id="draftId" placeholder="eg. 1252648379318534144" />
        </div>
        <div>
          <label class="tiny">Poll every (seconds)</label>
          <input id="pollSecs" type="number" min="1" step="1" value="1" />
        </div>
        <div>
          <label class="tiny">Position Filter</label>
          <select id="posFilter">
            <option value="ALL">All</option>
            <option>QB</option>
            <option>RB</option>
            <option>WR</option>
            <option>TE</option>
            <option>K</option>
            <option>DEF</option>
          </select>
        </div>
        <div>
          <label class="tiny">Search</label>
          <input id="search" placeholder="Name / team" />
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="btnRow" style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="startBtn" class="btn primary">‚ñ∂ Start</button>
          <button id="stopBtn" class="btn ghost">‚è∏ Stop</button>
          <button id="runTestsBtn" class="btn flat">üß™ Run tests</button>
          <button id="useSampleBtn" class="btn flat">üìÑ Use sample CSV</button>
          <button id="clearBtn" class="btn warn">üßπ Clear</button>
        </div>
        <div class="muted">Status: <span id="status">idle</span></div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label class="tiny">Load Rankings CSV (FantasyPros supported)</label>
          <input type="file" id="rankFile" accept=".csv, text/csv" />
        </div>
        <div>
          <label class="tiny">‚Ä¶or paste CSV here</label>
          <textarea id="rankPaste" rows="4" placeholder="Paste your CSV text here"></textarea>
          <div style="margin-top:6px">
            <button id="parsePasteBtn" class="btn ghost">Parse pasted CSV</button>
          </div>
        </div>
      </div>

      <div id="dropzone" class="dropzone tiny muted" style="margin-top:10px">Drop a CSV file here to load rankings</div>

      <div class="muted tiny" style="margin-top:10px">CSV headers auto‚Äëdetected. FantasyPros keys mapped: <span class="code">RK, PLAYER NAME, POS, TEAM, TIERS</span>. POS like <span class="code">WR1</span> is normalized to <span class="code">WR</span>; <span class="code">DST</span> becomes <span class="code">DEF</span>. Manual toggle lets you mark drafted if Sleeper misses one.</div>

      <div class="scroll" style="margin-top:12px">
        <table id="table">
          <thead>
            <tr>
              <th style="width:70px">Rank</th>
              <th>Player</th>
              <th style="width:60px">Pos</th>
              <th style="width:70px">Team</th>
              <th style="width:70px" class="right">Tier</th>
              <th style="width:90px" class="right">Drafted</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <aside class="card pad">
      <h2>Draft / Data</h2>
      <div class="grid" style="gap:8px">
        <div>Draft picks seen: <span class="stat" id="seen">0</span></div>
        <div>Available (filtered): <span class="stat" id="avail">0</span></div>
        <div>Polling: <span class="pill" id="polling">off</span></div>
      </div>
      <div style="margin-top:12px">
        <div class="tiny muted">Last 20 drafted (latest on top)</div>
        <ul id="recent" class="recent"></ul>
      </div>
      <div style="margin-top:12px">
        <div class="tiny muted">Diagnostics & Tests</div>
        <pre class="code" id="tests" style="min-height:80px;white-space:pre-wrap"></pre>
      </div>
      <div style="margin-top:12px">
        <div class="tiny muted">Errors</div>
        <pre class="code" id="errors" style="min-height:120px;white-space:pre-wrap"></pre>
      </div>
      <div style="margin-top:12px">
        <div class="tiny muted">Tips</div>
        <ul class="tiny">
          <li>If you click <b>Start</b> without rankings, the file picker opens automatically.</li>
          <li>Tier breaks have color accents; use the Position filter to slice the board.</li>
          <li>Polling every 2‚Äì3s is safe and near real‚Äëtime.</li>
        </ul>
      </div>
    </aside>
  </div>

  <!-- Robust CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const els = {
      draftId: document.getElementById('draftId'),
      pollSecs: document.getElementById('pollSecs'),
      posFilter: document.getElementById('posFilter'),
      search: document.getElementById('search'),
      startBtn: document.getElementById('startBtn'),
      stopBtn: document.getElementById('stopBtn'),
      runTestsBtn: document.getElementById('runTestsBtn'),
      useSampleBtn: document.getElementById('useSampleBtn'),
      clearBtn: document.getElementById('clearBtn'),
      parsePasteBtn: document.getElementById('parsePasteBtn'),
      rankFile: document.getElementById('rankFile'),
      rankPaste: document.getElementById('rankPaste'),
      dropzone: document.getElementById('dropzone'),
      status: document.getElementById('status'),
      tbody: document.getElementById('tbody'),
      seen: document.getElementById('seen'),
      avail: document.getElementById('avail'),
      polling: document.getElementById('polling'),
      errors: document.getElementById('errors'),
      tests: document.getElementById('tests'),
      recent: document.getElementById('recent'),
      themeToggle: document.getElementById('themeToggle')
    };

    let state = {
      rankings: [],               // normalized rows: {player_id, rank, name, pos, team, tier}
      playersIndex: {},           // Sleeper players by player_id
      draftedIds: new Set(),
      manualDrafted: new Set(),   // keys of manually marked drafted
      manualRecent: [],           // {name, team, pos, key, when, pick:null, manual:true}
      nameMatchCache: new Map(),  // cache by key
      timer: null,
      maxPickNo: 0,
      manualCounter: 0,
    };

    // ---------- theme ----------
    function initTheme(){
      const saved = localStorage.getItem('sleeper_theme') || 'dark';
      document.body.classList.toggle('light', saved === 'light');
      els.themeToggle.checked = (saved === 'light');
      els.themeToggle.addEventListener('change', (e)=>{
        const on = e.target.checked;
        document.body.classList.toggle('light', on);
        localStorage.setItem('sleeper_theme', on ? 'light' : 'dark');
      });
    }

    // ---------- utils ----------
    function now(){ return Date.now(); }
    function logErr(msg){
      console.error(msg);
      els.errors.textContent = (els.errors.textContent + "\n" + msg).trim();
    }
    function logTest(msg){
      els.tests.textContent = (els.tests.textContent + "\n" + msg).trim();
    }
    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    }
    function normName(n){
      return String(n||'').toLowerCase().replace(/[^a-z\s]/g,'').replace(/\b(jr|sr|ii|iii|iv|v)\b/g,'').replace(/\s+/g,' ').trim();
    }

    function firstToken(n){ return normName(n).split(' ')[0]||''; }
    function lastToken(n){ const parts = normName(n).split(' '); return parts[parts.length-1]||''; }
    function firstInitial(n){ return firstToken(n).slice(0,1); }

    function posSimplify(p){
      const raw = String(p||'').toUpperCase();
      const letters = (raw.match(/[A-Z]+/)||[''])[0];
      if(letters === 'DST') return 'DEF';
      return letters;
    }

    function uniqueKey(r){
      if(r.player_id) return 'pid:'+String(r.player_id);
      return 'nm:'+normName(r.name)+'|'+(r.pos||'')+'|'+(r.team||'');
    }

    function initials(name){
      const parts = (String(name||'').trim()).split(/\s+/).filter(Boolean);
      if(parts.length === 0) return '';
      if(parts.length === 1) return (parts[0][0]||'').toUpperCase();
      return (parts[0][0]||'').toUpperCase() + (parts[1][0]||'').toUpperCase();
    }

    // ---------- data loaders ----------
    async function loadPlayersIndex(){
      els.status.textContent = 'loading players‚Ä¶';
      const url = 'https://api.sleeper.app/v1/players/nfl';
      try{
        const res = await fetch(url);
        if(!res.ok){ throw new Error('players fetch failed ' + res.status); }
        const json = await res.json();
        state.playersIndex = json || {};
        els.status.textContent = 'players loaded';
      }catch(e){
        logErr('Players index load failed: ' + e.message);
      }
    }

    function parseCSV(text){
      try {
        const out = Papa.parse(text, { header: true, skipEmptyLines: true });
        if(out.errors && out.errors.length){
          logErr('CSV parser warnings: ' + out.errors.slice(0,3).map(e=>e.message).join(' | '));
        }
        const rows = out.data || [];
        const normRows = rows.map((row, i)=>{
          const o = {}; Object.keys(row).forEach(k=>{ o[k.toLowerCase()] = (row[k] ?? '').toString().trim(); });
          const rank = Number(o.rk || o.rank || (i+1));
          const name = o['player name'] || o.name || o.full_name || '';
          const pos = posSimplify(o.pos || o.position || '');
          const team = (o.team || o['team'] || '').toUpperCase();
          const tier = (o.tiers || o.tier || '').toString().trim();
          return { player_id: o.player_id || o.id || '', rank, name, pos, team, tier };
        }).filter(r=> r.player_id || r.name);
        return normRows;
      } catch(e){
        throw new Error('Failed to parse CSV: ' + e.message);
      }
    }

    // ---------- fuzzy attach (unchanged) ----------
    function fuzzyFindPlayerId(r){
      const cacheKey = normName(r.name)+'|'+(r.pos||'')+'|'+(r.team||'');
      if(state.nameMatchCache.has(cacheKey)) return state.nameMatchCache.get(cacheKey);

      const pos = r.pos || '';
      const rFirst = firstToken(r.name), rLast = lastToken(r.name), rInit = firstInitial(r.name);
      if(!rLast) return null;

      let best = { pid:null, score:0 };
      for(const pid in state.playersIndex){
        const p = state.playersIndex[pid];
        if(!p || !p.full_name) continue;
        if(pos && p.position !== pos) continue; // hard gate on pos

        const pFirst = firstToken(p.full_name), pLast = lastToken(p.full_name), pInit = firstInitial(p.full_name);
        if(pLast !== rLast) continue; // require same last name to avoid cross matches

        let score = 0;
        if(pFirst === rFirst) score += 0.7;
        else if(pInit && pInit === rInit) score += 0.5;
        else {
          const rF = rFirst.replace(/[^a-z]/g,'');
          const pF = pFirst.replace(/[^a-z]/g,'');
          if(rF && pF && (rF.startsWith(pF) || pF.startsWith(rF))) score += 0.4;
        }
        // nickname/initial expansions to disambiguate common initials
        const syn = {
          'j': ['josh','joshua'],
          'd': ['dj'],
          'k': ['kenneth','kaleb']
        };
        if(syn[rFirst] && syn[rFirst].includes(pFirst)) score += 0.6;

        if(r.team && p.team && r.team === p.team) score += 0.3;

        const a = normName(p.full_name), b = normName(r.name);
        const maxLen = Math.max(a.length,b.length)||1;
        let dist = 0;
        const minLen = Math.min(a.length,b.length);
        for(let i=0;i<minLen;i++){ if(a[i]!==b[i]) dist++; }
        const sim = 1 - (dist/maxLen);
        score += Math.max(0, Math.min(0.2, sim-0.7));

        if(score > best.score){ best = { pid, score }; }
      }

      const result = best.score >= 0.5 ? best.pid : null;
      state.nameMatchCache.set(cacheKey, result);
      return result;
    }

    function hydrateFromPlayers(r){
      if(r.player_id && state.playersIndex[r.player_id]){
        const p = state.playersIndex[r.player_id];
        return {
          ...r,
          name: r.name || p.full_name || ((p.first_name||'') + ' ' + (p.last_name||'')),
          pos: r.pos || p.position || '',
          team: r.team || p.team || '',
        };
      }
      if(!r.player_id && r.pos === 'DEF' && r.team){
        for(const pid in state.playersIndex){
          const p = state.playersIndex[pid];
          if(p && p.position === 'DEF' && p.team === r.team){ r.player_id = pid; break; }
        }
      }
      if(!r.player_id && r.name){
        const key = normName(r.name);
        for(const pid in state.playersIndex){
          const p = state.playersIndex[pid];
          const candidate = normName(p.full_name || ((p.first_name||'') + ' ' + (p.last_name||'')));
          if(candidate && candidate === key){ r.player_id = pid; r.pos = r.pos || p.position; r.team = r.team || p.team; break; }
        }
      }
      if(!r.player_id && r.name){
        const found = fuzzyFindPlayerId(r);
        if(found){
          const p = state.playersIndex[found];
          r.player_id = found; r.pos = r.pos || p.position; r.team = r.team || p.team;
        }
      }
      return r;
    }

    async function loadRankingsFromFile(file){
      const text = await file.text();
      state.rankings = parseCSV(text);
      computeAvailable();
      // auto-start if draft ID is present
      if(els.draftId.value.trim()){ start(); }
    }

    function loadRankingsFromPaste(){
      const text = els.rankPaste.value.trim();
      if(!text){ logErr('Paste area is empty.'); return; }
      state.rankings = parseCSV(text);
      computeAvailable();
      // auto-start if draft ID is present
      if(els.draftId.value.trim()){ start(); }
    }

    async function fetchDraftPicks(draftId){
      const res = await fetch(`https://api.sleeper.app/v1/draft/${draftId}/picks`);
      if(!res.ok){ throw new Error('draft picks fetch failed ' + res.status); }
      const picks = await res.json();
      state.draftedIds = new Set(picks.filter(p=>p.player_id).map(p=> String(p.player_id)));
      els.seen.textContent = picks.length;
      updateRecentFromAPI(picks);
    }

    // ---------- render & compute ----------
    function computeAvailable(){
      const pos = els.posFilter.value;
      const query = els.search.value.trim().toLowerCase();
      let list = state.rankings
        .map(hydrateFromPlayers)
        .filter(r => !state.draftedIds.has(String(r.player_id)))
        .filter(r => !state.manualDrafted.has(uniqueKey(r)));

      if(pos && pos !== 'ALL'){ list = list.filter(r=> (r.pos||'').toUpperCase() === pos); }
      if(query){ list = list.filter(r=> (r.name||'').toLowerCase().includes(query) || (r.team||'').toLowerCase().includes(query)); }

      list.sort((a,b)=> (a.rank||99999) - (b.rank||99999) || (String(a.tier).localeCompare(String(b.tier))));

      els.avail.textContent = list.length;
      renderTable(list.slice(0, 200)); // show top 200
    }

    function tierColor(tier){
      const t = String(tier).trim();
      if(t === '1') return 'var(--tier1)';
      if(t === '2') return 'var(--tier2)';
      if(t === '3') return 'var(--tier3)';
      if(t === '4') return 'var(--tier4)';
      if(t === '5') return 'var(--tier5)';
      return 'var(--tierOther)';
    }

    function renderTable(rows){
      const frag = document.createDocumentFragment();
      let lastTier = null;
      for(const r of rows){
        if(r.tier && r.tier !== lastTier){
          const trBreak = document.createElement('tr');
          trBreak.className = 'tierRow';
          const td = document.createElement('td');
          td.colSpan = 6;
          td.style.color = tierColor(r.tier);
          td.style.fontWeight = '600';
          td.textContent = `‚Äî Tier ${r.tier} ‚Äî`;
          trBreak.appendChild(td);
          frag.appendChild(trBreak);
          lastTier = r.tier;
        }
        const tr = document.createElement('tr');
        const key = uniqueKey(r);
        const checked = state.manualDrafted.has(key) ? 'checked' : '';

        const avatar = escapeHtml(initials(r.name || ''));

        tr.innerHTML = `
          <td>${r.rank ?? ''}</td>
          <td>
            <div class="playerCell">
              <div class="avatar">${avatar}</div>
              <div>
                <div class="playerName">${escapeHtml(r.name || '')}</div>
                <div class="playerMeta">${escapeHtml(r.pos || '')} ¬∑ ${escapeHtml(r.team || '')}</div>
              </div>
            </div>
          </td>
          <td>${escapeHtml(r.pos || '')}</td>
          <td>${escapeHtml(r.team || '')}</td>
          <td class="right" style="color:${tierColor(r.tier)}">${r.tier ?? ''}</td>
          <td class="right">
            <label class="toggle"><input type="checkbox" data-key="${escapeHtml(key)}" ${checked}/><span class="slider" title="Mark drafted"></span></label>
          </td>
        `;
        frag.appendChild(tr);
      }
      els.tbody.replaceChildren(frag);
      // wire checkboxes
      els.tbody.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
        chk.addEventListener('change', (e)=>{
          const key = e.target.getAttribute('data-key');
          const row = rows.find(r=> uniqueKey(r) === key);
          if(!row) return;
          if(e.target.checked){
            state.manualDrafted.add(key);
            state.manualCounter++;
            const when = (state.maxPickNo||0) + (state.manualCounter/1000);
            state.manualRecent.push({ name: row.name, team: row.team, pos: row.pos, key, when, pick:null, manual:true });
          } else {
            state.manualDrafted.delete(key);
            state.manualRecent = state.manualRecent.filter(x=> x.key !== key);
          }
          computeAvailable();
          renderRecent();
        });
      });
    }

    // ---------- recent picks ----------
    let lastApiRecent = [];
    function updateRecentFromAPI(picks){
      const sorted = [...picks].sort((a,b)=> (a.pick_no||0) - (b.pick_no||0));
      state.maxPickNo = Math.max(state.maxPickNo||0, ...sorted.map(p=> p.pick_no||0));
      const last20 = sorted.slice(-20).map(p=>{
        const pid = String(p.player_id||'');
        const pl = state.playersIndex[pid] || {};
        const nm = pl.full_name || ((pl.first_name||'')+' '+(pl.last_name||'')).trim() || (p.metadata?.first_name? (p.metadata.first_name+' '+(p.metadata.last_name||'')) : '');
        return { name: nm || '‚Äî', team: pl.team || p.metadata?.team || '', pos: pl.position || p.metadata?.position || '', pick: (p.pick_no||0), when: (p.pick_no||0), manual:false };
      });
      lastApiRecent = last20;
      renderRecent();
    }

    function renderRecent(){
      const combined = [...lastApiRecent, ...state.manualRecent];
      combined.sort((a,b)=> (b.when||0) - (a.when||0));
      const top = combined.slice(0,20);

      const frag = document.createDocumentFragment();
      top.forEach(it=>{
        const li = document.createElement('li');
        const left = document.createElement('span');
        left.className = 'nm';
        left.textContent = (it.pick?('#'+it.pick+' '):'') + (it.name||'‚Äî');
        const right = document.createElement('span');
        right.className = 'meta';
        right.textContent = `${it.pos||''} ¬∑ ${it.team||''}`;
        if(it.manual && it.key){
          const undo = document.createElement('button');
          undo.className = 'undoBtn';
          undo.textContent = 'Undo';
          undo.addEventListener('click', ()=>{
            state.manualDrafted.delete(it.key);
            state.manualRecent = state.manualRecent.filter(x=> x.key !== it.key);
            computeAvailable();
            renderRecent();
          });
          right.appendChild(undo);
        }
        li.appendChild(left); li.appendChild(right);
        frag.appendChild(li);
      });
      els.recent.replaceChildren(frag);
    }

    // ---------- control flow ----------
    function start(){
      els.errors.textContent = '';
      const draftId = els.draftId.value.trim();
      if(!draftId){ logErr('Enter a Draft ID'); return; }

      if(!state.rankings || state.rankings.length === 0){
        logErr('No rankings loaded. Opening file picker‚Ä¶');
        els.rankFile.click();
        return;
      }

      // clear any existing interval BEFORE turning polling UI on
      stop();

      els.status.textContent = 'starting‚Ä¶';
      els.polling.textContent = 'on';
      els.polling.style.background = 'rgba(46, 204, 113, .12)';

      const run = async ()=>{
        try{
          await fetchDraftPicks(draftId);
          computeAvailable();
          els.status.textContent = 'live';
        }catch(e){
          logErr(e.message);
          els.status.textContent = 'error';
        }
      };
      run();

      const ms = Math.max(1000, Number(els.pollSecs.value||2)*1000);
      state.timer = setInterval(run, ms);
    }

    function stop(){
      if(state.timer){ clearInterval(state.timer); state.timer = null; }
      els.polling.textContent = 'off';
      els.polling.style.background = '';
      els.status.textContent = 'paused';
    }

    function clearAll(){
      stop();
      state.rankings = [];
      state.draftedIds = new Set();
      state.manualDrafted = new Set();
      state.manualRecent = [];
      els.tbody.replaceChildren();
      els.recent.replaceChildren();
      els.avail.textContent = '0';
      els.seen.textContent = '0';
      els.errors.textContent = '';
      els.tests.textContent = '';
      els.status.textContent = 'idle';
    }

    // ---------- tests (unchanged) ----------
    function runTests(){
      els.tests.textContent = '';
      logTest('Running unit tests‚Ä¶');
      const csv1 = `RK,TIERS,PLAYER NAME,TEAM,POS,BYE WEEK,SOS SEASON,ECR VS. ADP\n1,1,Justin Jefferson,MIN,WR1,6,2 out of 5 stars,0`;
      const t1 = parseCSV(csv1)[0];
      if(t1 && t1.rank===1 && t1.name==='Justin Jefferson' && t1.pos==='WR' && t1.team==='MIN' && t1.tier==='1') logTest('‚úì Test 1: FantasyPros mapping OK'); else logTest('‚úó Test 1 FAILED ' + JSON.stringify(t1));

      const prior = state.playersIndex;
      state.playersIndex = {
        'p1': { full_name:'Brian Thomas Jr.', first_name:'Brian', last_name:'Thomas', position:'WR', team:'JAX' },
        'p2': { full_name:'Josh Allen', first_name:'Josh', last_name:'Allen', position:'QB', team:'BUF' },
        'p3': { full_name:'Josh Allen', first_name:'Josh', last_name:'Allen', position:'LB', team:'JAX' },
        'p4': { full_name:'DJ Moore', first_name:'DJ', last_name:'Moore', position:'WR', team:'CHI' },
        'p5': { full_name:'Kenneth Walker III', first_name:'Kenneth', last_name:'Walker', position:'RB', team:'SEA' },
        'p6': { full_name:'Kaleb Johnson', first_name:'Kaleb', last_name:'Johnson', position:'RB', team:'CHI' },
      };

      let h = hydrateFromPlayers({ player_id:'', rank:20, name:'B. Thomas', pos:'WR', team:'JAX', tier:'2' });
      if(h.player_id==='p1') logTest('‚úì Test 2: Fuzzy B. Thomas ‚Üí Brian Thomas Jr. OK'); else logTest('‚úó Test 2 FAILED ' + JSON.stringify(h));

      h = hydrateFromPlayers({ player_id:'', rank:15, name:'J. Allen', pos:'QB', team:'BUF', tier:'1' });
      if(h.player_id==='p2') logTest('‚úì Test 3: Fuzzy J. Allen ‚Üí Josh Allen (QB) OK'); else logTest('‚úó Test 3 FAILED ' + JSON.stringify(h));

      h = hydrateFromPlayers({ player_id:'', rank:35, name:'D. Moore', pos:'WR', team:'CHI', tier:'3' });
      if(h.player_id==='p4') logTest('‚úì Test 4: Fuzzy D. Moore ‚Üí DJ Moore OK'); else logTest('‚úó Test 4 FAILED ' + JSON.stringify(h));

      h = hydrateFromPlayers({ player_id:'', rank:28, name:'K. Walker', pos:'RB', team:'SEA', tier:'2' });
      if(h.player_id==='p5') logTest('‚úì Test 5: Fuzzy K. Walker ‚Üí Kenneth Walker III OK'); else logTest('‚úó Test 5 FAILED ' + JSON.stringify(h));

      state.playersIndex = prior;
      h = hydrateFromPlayers({ player_id:'', rank:40, name:'K. Johnson', pos:'RB', team:'CHI', tier:'4' });
      if(h.player_id==='p6') logTest('‚úì Test 6: Fuzzy K. Johnson ‚Üí Kaleb Johnson OK'); else logTest('‚úó Test 6 FAILED ' + JSON.stringify(h));

      state.playersIndex = prior;
      logTest('Tests complete.');
    }

    const SAMPLE_CSV = `RK,TIERS,PLAYER NAME,TEAM,POS,BYE WEEK,SOS SEASON,ECR VS. ADP\n1,1,Justin Jefferson,MIN,WR1,6,2 out of 5 stars,0\n2,1,Bijan Robinson,ATL,RB1,5,4 out of 5 stars,0\n3,1,CeeDee Lamb,DAL,WR2,10,2 out of 5 stars,+3\n120,6,49ers D/ST,SF,DST,9,2 out of 5 stars,0`;

    // ---------- wire UI ----------
    els.startBtn.onclick = start;
    els.stopBtn.onclick = stop;
    els.clearBtn.onclick = clearAll;
    els.runTestsBtn.onclick = runTests;
    els.useSampleBtn.onclick = ()=>{ els.rankPaste.value = SAMPLE_CSV; loadRankingsFromPaste(); };
    els.parsePasteBtn.onclick = loadRankingsFromPaste;
    els.rankFile.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      try{ await loadRankingsFromFile(f); } catch(err){ logErr(err.message); }
    });

    ;['dragenter','dragover'].forEach(evt => els.dropzone.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); els.dropzone.style.background='rgba(255,255,255,.02)'; }));
    ;['dragleave','drop'].forEach(evt => els.dropzone.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); els.dropzone.style.background=''; }));
    els.dropzone.addEventListener('drop', async (e)=>{
      const f = e.dataTransfer?.files?.[0]; if(!f) return; try{ await loadRankingsFromFile(f); } catch(err){ logErr(err.message); }
    });

    els.posFilter.onchange = computeAvailable;
    els.search.oninput = computeAvailable;

    (async ()=>{
      try{ await loadPlayersIndex(); }
      catch(e){ logErr(e.message); }
    })();

    // init theme
    initTheme();
  </script>
</body>
</html>
